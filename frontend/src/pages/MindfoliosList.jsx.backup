import React, { useEffect, useState } from "react";
import { pfClient } from "../services/mindfolioClient";
import { Link } from "react-router-dom";
import MindfolioTemplateModal from "../components/MindfolioTemplateModal";

export default function MindfoliosList() {
 const [items, setItems] = useState([]);
 const [loading, setLoading] = useState(true);
 const [err, setErr] = useState("");
 const [searchQuery, setSearchQuery] = useState("");
 const [filterStatus, setFilterStatus] = useState("ALL");
 const [sortBy, setSortBy] = useState("name");
 const [showTemplateModal, setShowTemplateModal] = useState(false);

 useEffect(() => {
 let mounted = true;
 
 pfClient.list()
 .then(data => {
 if (!mounted) return;
 setItems(data);
 })
 .catch(e => setErr(String(e)))
 .finally(() => setLoading(false));
 
 return () => { mounted = false; };
 }, []);

 // Filter and sort logic - MUST be before early returns to maintain consistent hook order
 const filteredAndSortedItems = React.useMemo(() => {
 let result = [...items];

 // Apply search filter
 if (searchQuery.trim()) {
 const query = searchQuery.toLowerCase();
 result = result.filter(p => 
 p.name?.toLowerCase().includes(query) ||
 p.id?.toLowerCase().includes(query) ||
 p.modules?.some(m => m.module?.toLowerCase().includes(query))
 );
 }

 // Apply status filter
 if (filterStatus !== "ALL") {
 result = result.filter(p => p.status === filterStatus);
 }

 // Apply sorting
 result.sort((a, b) => {
 switch (sortBy) {
 case "name":
 return (a.name || "").localeCompare(b.name || "");
 case "balance":
 return (b.cash_balance || 0) - (a.cash_balance || 0);
 case "created":
 return new Date(b.created_at) - new Date(a.created_at);
 case "status":
 return (a.status || "").localeCompare(b.status || "");
 default:
 return 0;
 }
 });

 return result;
 }, [items, searchQuery, filterStatus, sortBy]);

 // Calculate totals and counts
 const totalValue = items.reduce((sum, pf) => sum + (pf.cash_balance || 0), 0);
 const totalMindfolios = items.length;
 const activeCount = items.filter(p => p.status === 'ACTIVE').length;
 const pausedCount = items.filter(p => p.status === 'PAUSED').length;

 // Early returns AFTER all hooks
 if (loading) {
 return (
 <div className="p-8">
 <div className="flex items-center justify-center h-64">
 <div className="text-center">
 <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
 <div className="text-gray-400">Loading mindfolios...</div>
 </div>
 </div>
 </div>
 );
 }
 
 if (err) {
 return (
 <div className="p-8">
 <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-6">
 <div className="flex items-start gap-3">
 <span className="text-lg"></span>
 <div>
 <div className="font-semibold text-red-400 mb-2">Error Loading Mindfolios</div>
 <div className="text-sm text-gray-400">{err}</div>
 </div>
 </div>
 </div>
 </div>
 );
 }

 return (
 <>
 <div className="p-8 space-y-6">
 {/* Header */}
 <div className="flex items-center justify-between">
 <div>
 <h1 className="text-xl font-bold text-white mb-2">üíº Mindfolios</h1>
 <p className="text-gray-400">Manage your trading mindfolios and track performance</p>
 </div>
 <button 
 onClick={() => setShowTemplateModal(true)}
 className="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all hover:scale-105 shadow-lg"
 >
 ‚ú® Create Mindfolio
 </button>
 </div>

 {/* Stats Cards */}
 <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
 <div className="bg-slate-800/50 border border-slate-700 rounded-lg p-6">
 <div className="text-sm text-gray-400 mb-1">Total Mindfolios</div>
 <div className="text-xl font-bold text-white">{totalMindfolios}</div>
 </div>
 <div className="bg-slate-800/50 border border-slate-700 rounded-lg p-6">
 <div className="text-sm text-gray-400 mb-1">Total Cash</div>
 <div className="text-xl font-bold text-green-400">
 ${totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
 </div>
 </div>
 <div className="bg-slate-800/50 border border-slate-700 rounded-lg p-6">
 <div className="text-sm text-gray-400 mb-1">Active</div>
 <div className="text-xl font-bold text-green-400">{activeCount}</div>
 </div>
 <div className="bg-slate-800/50 border border-slate-700 rounded-lg p-6">
 <div className="text-sm text-gray-400 mb-1">Paused</div>
 <div className="text-xl font-bold text-yellow-400">{pausedCount}</div>
 </div>
 </div>

 {/* Search, Filter, Sort Controls */}
 <div className="bg-slate-800/50 border border-slate-700 rounded-lg p-4">
 <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
 {/* Search */}
 <div className="relative">
 <input
 type="text"
 placeholder="Search mindfolios..."
 value={searchQuery}
 onChange={(e) => setSearchQuery(e.target.value)}
 className="w-full bg-gray-900 border border-gray-700 text-white rounded-lg px-4 py-2 pl-10 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors"
 />
 </div>

 {/* Filter by Status */}
 <div>
 <select
 value={filterStatus}
 onChange={(e) => setFilterStatus(e.target.value)}
 className="w-full bg-gray-900 border border-gray-700 text-white rounded-lg px-4 py-2 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors"
 >
 <option value="ALL">All Status</option>
 <option value="ACTIVE"> Active Only</option>
 <option value="PAUSED">‚è∏Ô∏è Paused Only</option>
 <option value="CLOSED"> Closed Only</option>
 </select>
 </div>

 {/* Sort by */}
 <div>
 <select
 value={sortBy}
 onChange={(e) => setSortBy(e.target.value)}
 className="w-full bg-gray-900 border border-gray-700 text-white rounded-lg px-4 py-2 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors"
 >
 <option value="name"> Sort by Name</option>
 <option value="balance">Sort by Balance</option>
 <option value="created"> Sort by Date</option>
 <option value="status"> Sort by Status</option>
 </select>
 </div>
 </div>

 {/* Active filters indicator */}
 {(searchQuery || filterStatus !== "ALL") && (
 <div className="mt-3 flex items-center gap-2 text-sm">
 <span className="text-gray-400">Active filters:</span>
 {searchQuery && (
 <span className="px-2 py-1 bg-blue-500/20 text-blue-400 rounded border border-blue-500/30">
 Search: "{searchQuery}"
 </span>
 )}
 {filterStatus !== "ALL" && (
 <span className="px-2 py-1 bg-green-500/20 text-green-400 rounded border border-green-500/30">
 Status: {filterStatus}
 </span>
 )}
 <button
 onClick={() => {
 setSearchQuery("");
 setFilterStatus("ALL");
 }}
 className="ml-2 text-xs text-gray-400 hover:text-white transition-colors"
 >
 ‚úï Clear all
 </button>
 </div>
 )}
 </div>
 
 {filteredAndSortedItems.length === 0 ? (
 <div className="text-center py-16 bg-slate-800/30 border border-slate-700 rounded-lg">
 <div className="text-xl mb-4">
 {items.length === 0 ? "" : ""}
 </div>
 <div className="text-base text-gray-300 mb-2">
 {items.length === 0 ? "No mindfolios yet" : "No mindfolios match your filters"}
 </div>
 <div className="text-gray-500 mb-6">
 {items.length === 0 
 ? "Create your first mindfolio to start tracking your trades"
 : "Try adjusting your search or filter criteria"
 }
 </div>
 {items.length === 0 ? (
 <Link 
 to="/mindfolios/new"
 className="inline-block px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all hover:scale-105"
 >
 Create Your First Mindfolio
 </Link>
 ) : (
 <button
 onClick={() => {
 setSearchQuery("");
 setFilterStatus("ALL");
 }}
 className="inline-block px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all hover:scale-105"
 >
 Clear Filters
 </button>
 )}
 </div>
 ) : (
 <>
 {/* Results count */}
 <div className="flex items-center justify-between text-sm text-gray-400">
 <span>
 Showing {filteredAndSortedItems.length} of {totalMindfolios} mindfolio{totalMindfolios !== 1 ? 's' : ''}
 </span>
 <span>
 Sorted by: <span className="text-blue-400 font-semibold">
 {sortBy === 'name' ? 'Name' : sortBy === 'balance' ? 'Balance' : sortBy === 'created' ? 'Date' : 'Status'}
 </span>
 </span>
 </div>

 <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
 {filteredAndSortedItems.map(p => {
 const statusColors = {
 'ACTIVE': 'bg-green-500/20 text-green-400 border-green-500/30',
 'PAUSED': 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',
 'CLOSED': 'bg-gray-500/20 text-gray-400 border-gray-500/30'
 };
 
 return (
 <Link 
 key={p.id} 
 to={`/mindfolios/${p.id}`} 
 className="group bg-slate-800/50 border border-slate-700 rounded-xl p-6 hover:bg-slate-800 hover:border-slate-600 transition-all hover:shadow-xl hover:scale-105"
 >
 {/* Header */}
 <div className="flex items-start justify-between mb-4">
 <div className="flex-1">
 <div className="text-base font-bold text-white group-hover:text-blue-400 transition-colors mb-1">
 {p.name}
 </div>
 <div className="text-xs text-gray-500">
 ID: {p.id?.substring?.(0, 8) || p.id}
 </div>
 </div>
 <div className={`px-3 py-1 rounded-full text-xs font-semibold border ${statusColors[p.status] || statusColors.CLOSED}`}>
 {p.status}
 </div>
 </div>

 {/* Cash Balance */}
 <div className="bg-slate-900/50 rounded-lg p-4 mb-4">
 <div className="text-sm text-gray-400 mb-1">Cash Balance</div>
 <div className="text-lg font-bold text-green-400">
 ${(p.cash_balance || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
 </div>
 </div>

 {/* Modules */}
 <div className="space-y-2">
 <div className="text-sm text-gray-400 font-semibold">Modules ({p.modules?.length || 0})</div>
 {p.modules && p.modules.length > 0 ? (
 <div className="flex flex-wrap gap-2">
 {p.modules.map((m, idx) => (
 <div 
 key={idx}
 className="px-2 py-1 bg-blue-500/20 text-blue-400 text-xs rounded border border-blue-500/30"
 >
 {m.module}
 </div>
 ))}
 </div>
 ) : (
 <div className="text-xs text-gray-500">No modules configured</div>
 )}
 </div>

 {/* Footer - Dates */}
 <div className="mt-4 pt-4 border-t border-slate-700/50 flex items-center justify-between text-xs text-gray-500">
 <span>Created: {new Date(p.created_at).toLocaleDateString()}</span>
 <span className="text-blue-400 group-hover:text-blue-300">View ‚Üí</span>
 </div>
 </Link>
 );
 })}
 </div>
 </>
 )}
 </div>

 {/* Template Selection Modal */}
 {showTemplateModal && (
 <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
 <div className="bg-slate-800 border border-slate-700 rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
 {/* Modal Header */}
 <div className="sticky top-0 bg-slate-800 border-b border-slate-700 p-6 flex items-center justify-between">
 <div>
 <h2 className="text-2xl font-bold text-white mb-1">‚ú® Create New Mindfolio</h2>
 <p className="text-gray-400 text-sm">Choose a template to get started quickly</p>
 </div>
 <button 
 onClick={() => {
 setShowTemplateModal(false);
 setSelectedTemplate(null);
 setMindfolioName("");
 }}
 className="text-gray-400 hover:text-white transition-colors"
 >
 <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
 <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
 </svg>
 </button>
 </div>

 {/* Templates Grid */}
 <div className="p-6">
 {loadingTemplates ? (
 <div className="text-center py-12">
 <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
 <div className="text-gray-400">Loading templates...</div>
 </div>
 ) : (
 <>
 <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
 {templates.map((template) => (
 <button
 key={template.id}
 onClick={() => {
 setSelectedTemplate(template);
 setMindfolioName(template.name);
 }}
 className={`text-left p-6 rounded-lg border-2 transition-all hover:scale-105 ${
 selectedTemplate?.id === template.id
 ? 'border-blue-500 bg-blue-500/10'
 : 'border-slate-700 bg-slate-900/50 hover:border-slate-600'
 }`}
 >
 <div className="flex items-start gap-4">
 <div className="text-4xl">{template.icon}</div>
 <div className="flex-1">
 <div className="flex items-center gap-2 mb-2">
 <h3 className="text-lg font-bold text-white">{template.name}</h3>
 <span className={`px-2 py-0.5 text-xs rounded-full ${
 template.risk_level === 'HIGH' ? 'bg-red-500/20 text-red-400 border border-red-500/30' :
 template.risk_level === 'MEDIUM' ? 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30' :
 template.risk_level === 'LOW' ? 'bg-green-500/20 text-green-400 border border-green-500/30' :
 'bg-gray-500/20 text-gray-400 border border-gray-500/30'
 }`}>
 {template.risk_level}
 </span>
 </div>
 <p className="text-sm text-gray-400 mb-3">{template.description}</p>
 <div className="text-xs text-gray-500 mb-2">üíµ Starting Balance: ${template.starting_balance.toLocaleString()}</div>
 <div className="text-xs text-gray-500 mb-2">ü§ñ Modules: {template.modules.length}</div>
 <div className="text-xs text-blue-400">{template.recommended_for}</div>
 </div>
 </div>
 </button>
 ))}
 </div>

 {/* Create Form (shown when template selected) */}
 {selectedTemplate && (
 <div className="bg-slate-900/50 border border-slate-700 rounded-lg p-6 space-y-4">
 <div>
 <label className="block text-sm font-semibold text-white mb-2">
 Mindfolio Name
 </label>
 <input
 type="text"
 value={mindfolioName}
 onChange={(e) => setMindfolioName(e.target.value)}
 placeholder="Enter mindfolio name..."
 className="w-full bg-gray-900 border border-gray-700 text-white rounded-lg px-4 py-3 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-colors"
 />
 </div>

 <div className="bg-slate-800/50 rounded-lg p-4">
 <div className="text-sm font-semibold text-white mb-3">Template Configuration</div>
 <div className="space-y-2 text-sm">
 <div className="flex justify-between text-gray-400">
 <span>Starting Balance:</span>
 <span className="text-white font-mono">${selectedTemplate.starting_balance.toLocaleString()}</span>
 </div>
 <div className="flex justify-between text-gray-400">
 <span>Modules:</span>
 <span className="text-white">{selectedTemplate.modules.length} configured</span>
 </div>
 <div className="flex justify-between text-gray-400">
 <span>Risk Level:</span>
 <span className={`font-semibold ${
 selectedTemplate.risk_level === 'HIGH' ? 'text-red-400' :
 selectedTemplate.risk_level === 'MEDIUM' ? 'text-yellow-400' :
 selectedTemplate.risk_level === 'LOW' ? 'text-green-400' :
 'text-gray-400'
 }`}>{selectedTemplate.risk_level}</span>
 </div>
 </div>
 </div>

 {/* Modules Preview */}
 {selectedTemplate.modules.length > 0 && (
 <div className="bg-slate-800/50 rounded-lg p-4">
 <div className="text-sm font-semibold text-white mb-3">üì¶ Module Allocations</div>
 <div className="space-y-2">
 {selectedTemplate.modules.map((module, idx) => (
 <div key={idx} className="flex items-center justify-between text-xs bg-slate-900/50 rounded p-3">
 <div>
 <div className="text-white font-semibold">{module.module}</div>
 <div className="text-gray-500">
 Max Risk: ${module.max_risk_per_trade} ‚Ä¢ Daily Limit: ${module.daily_loss_limit}
 </div>
 </div>
 <div className="text-right">
 <div className="text-white font-mono">${module.budget.toLocaleString()}</div>
 <div className="text-gray-500">{((module.budget / selectedTemplate.starting_balance) * 100).toFixed(1)}%</div>
 </div>
 </div>
 ))}
 </div>
 </div>
 )}

 {/* Create Button */}
 <button
 onClick={async () => {
 if (!mindfolioName.trim()) {
 alert('Please enter a mindfolio name');
 return;
 }
 
 setCreating(true);
 try {
 const response = await fetch(`${process.env.REACT_APP_BACKEND_URL || ""}/api/mindfolio`, {
 method: 'POST',
 headers: {
 'Content-Type': 'application/json',
 'X-User-ID': 'default'
 },
 body: JSON.stringify({
 name: mindfolioName,
 starting_balance: selectedTemplate.starting_balance,
 modules: selectedTemplate.modules
 })
 });

 if (!response.ok) throw new Error('Failed to create mindfolio');

 const data = await response.json();
 
 // Refresh list
 const updatedList = await pfClient.list();
 setItems(updatedList);
 
 // Close modal
 setShowTemplateModal(false);
 setSelectedTemplate(null);
 setMindfolioName("");
 
 // Show success message (optional - could add toast notification)
 alert(`‚úÖ Mindfolio "${mindfolioName}" created successfully!`);
 } catch (e) {
 alert(`‚ùå Failed to create mindfolio: ${e.message}`);
 } finally {
 setCreating(false);
 }
 }}
 disabled={creating || !mindfolioName.trim()}
 className={`w-full py-3 rounded-lg font-semibold transition-all ${
 creating || !mindfolioName.trim()
 ? 'bg-gray-700 text-gray-500 cursor-not-allowed'
 : 'bg-blue-600 hover:bg-blue-700 text-white hover:scale-105'
 }`}
 >
 {creating ? (
 <span className="flex items-center justify-center gap-2">
 <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
 Creating...
 </span>
 ) : (
 `‚ú® Create ${mindfolioName || 'Mindfolio'}`
 )}
 </button>
 </div>
 )}
 </>
 )}
 </div>
 </div>
 </div>
 )}
 </>
 );
}