workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Etape extinse pentru code-quality & SAST
stages: [fe, be, test, quality, sast, gate]

include:
  # Code Quality (CodeClimate)
  - template: Code-Quality.gitlab-ci.yml
  # SAST (Security scanning)
  - template: Security/SAST.gitlab-ci.yml

variables:
  NODE_OPTIONS: --max-old-space-size=2048
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/.cache/npm"

  # Mutăm SAST în etapa dedicată
  SAST_STAGE: "sast"
  # Code Quality activ
  CODE_QUALITY_DISABLED: "false"

# ---------- FRONTEND ----------
frontend:
  stage: fe
  image: node:20
  cache:
    key: "${CI_COMMIT_REF_SLUG}-fe"
    paths: [ .cache/npm/ ]
  before_script:
    - cd frontend
    - |
      if [ -f yarn.lock ]; then
        corepack enable
        yarn --version
        yarn install --immutable
      else
        npm ci
      fi
  script:
    - |
      if [ -f yarn.lock ]; then
        yarn run lint
        if grep -q '"build"' package.json; then yarn build; fi
        yarn audit --level high
        # coverage HTML dacă există test script / jest
        if jq -e '.scripts.test' package.json >/dev/null 2>&1 || grep -qi jest package.json; then
          yarn test --coverage --coverageReporters=cobertura --coverageReporters=html || true
        fi
      else
        npm run lint
        npm run build --if-present
        npm audit --audit-level=high
        if jq -e '.scripts.test' package.json >/dev/null 2>&1 || grep -qi jest package.json; then
          npm run -s test -- --ci --coverage --coverageReporters=cobertura --coverageReporters=html || true
        fi
      fi
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - frontend/build/
      - frontend/coverage/            # HTML jest coverage (dacă există)
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# ---------- BACKEND ----------
backend:
  stage: be
  image: python:3.11
  cache:
    key: "${CI_COMMIT_REF_SLUG}-be"
    paths: [ .cache/pip/ ]
  before_script:
    - cd backend
    - pip install -U pip
    - pip install ruff mypy bandit pytest pip-audit pytest-cov coverage flake8 flake8-html
    - |
      if [ -f requirements.txt ]; then
        pip install -r requirements.txt
      fi
    - mkdir -p reports/flake8 reports/bandit reports/mypy reports/coverage_html
  script:
    # Gates (fail la erori reale)
    - ruff --output-format=github check .
    - ruff format --check
    - mypy . --ignore-missing-imports --pretty
    - bandit -ll -r . -x tests
    - |
      if [ -f requirements.txt ]; then
        pip-audit -r requirements.txt --strict
      else
        pip-audit --strict
      fi
    # Coverage (Cobertura + HTML) — nu blochează MR dacă nu ai teste încă
    - pytest -q --maxfail=1 --disable-warnings --cov=. --cov-report=xml:coverage.xml --cov-report=html:reports/coverage_html || true
    # Artifacte HTML (nu blochează MR)
    - flake8 . --format=html --htmldir reports/flake8 || true
    - bandit -r . -f html -o reports/bandit/index.html || true
    - mypy . --ignore-missing-imports --html-report reports/mypy || true
  artifacts:
    when: always
    expire_in: 1 week
    reports:
      junit: backend/junit-report.xml   # dacă generezi JUnit separat
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage.xml
    paths:
      - backend/reports/flake8/
      - backend/reports/bandit/
      - backend/reports/mypy/
      - backend/reports/coverage_html/
      - backend/.ruff_cache/
      - backend/.mypy_cache/
      - backend/coverage.xml
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# ---------- CODE QUALITY GATE (folosește artifactul din jobul code_quality) ----------
quality-gate:
  stage: quality
  image: alpine:3.19
  needs: [code_quality]
  dependencies: [code_quality]
  script:
    - apk add --no-cache jq >/dev/null
    - FILE="gl-code-quality-report.json"
    - |
      if [ ! -f "$FILE" ]; then
        echo "WARN: lipsește $FILE (Code Quality). Trecem cu verde."
        exit 0
      fi
    - COUNT=$(jq 'length' "$FILE")
    - echo "Code Quality issues: $COUNT"
    - MAX=${QUALITY_MAX_ISSUES:-0}
    - if [ "$COUNT" -le "$MAX" ]; then echo "OK: $COUNT <= $MAX"; else echo "FAIL: $COUNT > $MAX"; exit 1; fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# ---------- SAST ----------
# definit în template; rulează în stage "sast" datorită SAST_STAGE de mai sus

# ---------- GATE ----------
gate:
  stage: gate
  image: alpine:3.19
  needs: [frontend, backend, quality-gate]
  script: [ 'echo "All enterprise gates passed ✅"' ]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
